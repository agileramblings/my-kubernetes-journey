version: '3.4'

services:
  dnsutil:
    container_name: dnsutils
    image: gcr.io/kubernetes-e2e-test-images/dnsutils:1.3
    command: "sleep 3600"

  postgresdb:
    image: postgres:alpine
    hostname: postgres
    ports:
      - "5432:5432"
    container_name: postgresdb
    environment:
      - "POSTGRES_USER=admin"
      - "POSTGRES_PASSWORD=P@ssw0rd!"
      - "POSTGRES_DB=identity" # this is the db name that will be generated by EFCore
    volumes:
      - postgresdata:/var/lib/postgresql/data
    networks:
      default:
        aliases:
          - postgres

  pgAdmin4: 
    image: dpage/pgadmin4:4.20
    ports: 
      - "5050:80"
    container_name: pgAdmin4
    environment:
      - "PGADMIN_DEFAULT_EMAIL=admin@codingwithdave.xyz"
      - "PGADMIN_DEFAULT_PASSWORD=P@ssw0rd!"
      - "PGDATA=/mnt/data/pgdata"
    volumes:
      - pgdata:/mnt/data/pgdata

  seq:
    container_name: seq
    image: datalust/seq:preview
    ports: 
      - "5341:80"
    environment: 
      - "ACCEPT_EULA=Y"
    networks:
      default:
        aliases:
          - seq

  myproject.admin:
    image: ${DOCKER_REGISTRY-}skoruba-identityserver4-admin
    ports:
      - 9000:80
    links:
      - "seq:seq"
    build:
      context: .
      dockerfile: src/MyProject.Admin/Dockerfile
    container_name: skoruba-identityserver4-admin
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - "ConnectionStrings__ConfigurationDbConnection=Server=postgres; User Id=admin; Database=identity; Port=5432; Password=P@ssw0rd!; SSL Mode=Prefer; Trust Server Certificate=true;"
      - "ConnectionStrings__PersistedGrantDbConnection=Server=postgres; User Id=admin; Database=identity; Port=5432; Password=P@ssw0rd!; SSL Mode=Prefer; Trust Server Certificate=true;"
      - "ConnectionStrings__IdentityDbConnection=Server=postgres; User Id=admin; Database=identity; Port=5432; Password=P@ssw0rd!; SSL Mode=Prefer; Trust Server Certificate=true;"
      - "ConnectionStrings__AdminLogDbConnection=Server=postgres; User Id=admin; Database=identity; Port=5432; Password=P@ssw0rd!; SSL Mode=Prefer; Trust Server Certificate=true;"
      - "ConnectionStrings__AdminAuditLogDbConnection=Server=postgres; User Id=admin; Database=identity; Port=5432; Password=P@ssw0rd!; SSL Mode=Prefer; Trust Server Certificate=true;"
      - "AdminConfiguration__IdentityAdminBaseUrl=http://127.0.0.1.xip.io:9000"
      - "AdminConfiguration__IdentityAdminRedirectUri=http://127.0.0.1.xip.io:9000/signin-oidc"
      - "AdminConfiguration__IdentityServerBaseUrl=http://127.0.0.1.xip.io"
      - "AdminConfiguration__RequireHttpsMetadata=false"
      - "IdentityServerData__Clients__0__ClientUri=http://127.0.0.1.xip.io:9000"
      - "IdentityServerData__Clients__0__RedirectUris__0=http://127.0.0.1.xip.io:9000/signin-oidc"
      - "IdentityServerData__Clients__0__FrontChannelLogoutUri=http://127.0.0.1.xip.io:9000/signin-oidc"
      - "IdentityServerData__Clients__0__PostLogoutRedirectUris__0=http://127.0.0.1.xip.io:9000/signout-callback-oidc"
      - "IdentityServerData__Clients__0__AllowedCorsOrigins__0=http://127.0.0.1.xip.io:9000"
      - "IdentityServerData__Clients__1__RedirectUris__0=http://127.0.0.1.xip.io:5000/swagger/oauth2-redirect.html"
    depends_on:
      - postgresdb
      - myproject.sts.identity
    volumes:
      - "./shared/serilog.json:/app/serilog.json"
      - "./shared/identitydata.json:/app/identitydata.json"
      - "./shared/identityserverdata.json:/app/identityserverdata.json"

  myproject.admin.api:
    image: ${DOCKER_REGISTRY-}skoruba-identityserver4-admin-api
    build:
      context: .
      dockerfile: src/MyProject.Admin.Api/Dockerfile
    ports:
      - 5000:80
    environment:
      - "AdminApiConfiguration__RequireHttpsMetadata=false"
      - "AdminApiConfiguration__ApiBaseUrl=http://127.0.0.1.xip.io:5000"
      - "AdminApiConfiguration__IdentityServerBaseUrl=http://127.0.0.1.xip.io"
      - "ConnectionStrings__ConfigurationDbConnection=Server=postgres; User Id=admin; Database=identity; Port=5432; Password=P@ssw0rd!; SSL Mode=Prefer; Trust Server Certificate=true;"
      - "ConnectionStrings__PersistedGrantDbConnection=Server=postgres; User Id=admin; Database=identity; Port=5432; Password=P@ssw0rd!; SSL Mode=Prefer; Trust Server Certificate=true;"
      - "ConnectionStrings__IdentityDbConnection=Server=postgres; User Id=admin; Database=identity; Port=5432; Password=P@ssw0rd!; SSL Mode=Prefer; Trust Server Certificate=true;"
      - "ConnectionStrings__AdminLogDbConnection=Server=postgres; User Id=admin; Database=identity; Port=5432; Password=P@ssw0rd!; SSL Mode=Prefer; Trust Server Certificate=true;"
      - "ConnectionStrings__AdminAuditLogDbConnection=Server=postgres; User Id=admin; Database=identity; Port=5432; Password=P@ssw0rd!; SSL Mode=Prefer; Trust Server Certificate=true;"
    container_name: skoruba-identityserver4-admin-api
    volumes:
      - "./shared/serilog.json:/app/serilog.json"

  myproject.sts.identity:
    image: ${DOCKER_REGISTRY-}skoruba-identityserver4-sts-identity
    ports:
      - 80:80
    build:
      context: .
      dockerfile: src/MyProject.STS.Identity/Dockerfile
    container_name: skoruba-identityserver4-sts-identity
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - "ConnectionStrings__ConfigurationDbConnection=Server=postgres; User Id=admin; Database=identity; Port=5432; Password=P@ssw0rd!; SSL Mode=Prefer; Trust Server Certificate=true;"
      - "ConnectionStrings__PersistedGrantDbConnection=Server=postgres; User Id=admin; Database=identity; Port=5432; Password=P@ssw0rd!; SSL Mode=Prefer; Trust Server Certificate=true;"
      - "ConnectionStrings__IdentityDbConnection=Server=postgres; User Id=admin; Database=identity; Port=5432; Password=P@ssw0rd!; SSL Mode=Prefer; Trust Server Certificate=true;"
      - "AdminConfiguration__IdentityAdminBaseUrl=http://127.0.0.1.xip.io:9000"
    depends_on:
      - postgresdb
    volumes:
      - "./shared/serilog.json:/app/serilog.json"
    networks:
      default:
        aliases:
          - 127.0.0.1.xip.io

volumes:
  postgresdata:
    driver: local
  pgdata:
    driver: local

networks:
  default:
    driver: bridge